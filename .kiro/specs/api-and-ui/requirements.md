# Requirements Document

## Introduction

The API and UI module provides the web interface layer for the Conversational RAG E-commerce Application. It consists of a FastAPI backend that exposes REST API endpoints for chat functionality (integrating with the inference pipeline), and a Streamlit-based frontend with a collapsible chat interface and session history panel. The system supports streaming responses and persists conversation sessions to files for reference.

## Glossary

- **Chat_API**: FastAPI backend that handles chat requests and integrates with the inference pipeline
- **Chat_Router**: FastAPI router containing all chat-related endpoints
- **Session_Store**: File-based storage system for persisting conversation sessions
- **Chat_Interface**: Collapsible Streamlit chat widget positioned in the right corner
- **Session_Panel**: Sidebar panel displaying conversation history and past sessions with simple ona page ecommerce banner.
- **API_Client**: Frontend component that communicates with the FastAPI backend
- **Stream_Handler**: Component that handles Server-Sent Events (SSE) for streaming responses

## Requirements

### Requirement 1: Chat API Endpoint

**User Story:** As a developer, I want a REST API endpoint for chat, so that any client can send messages and receive AI-powered responses.

#### Acceptance Criteria

1. THE Chat_API SHALL expose a `POST /api/chat` endpoint that accepts a query and session_id
2. THE Chat_API SHALL integrate with the Inference_Pipeline to generate responses
3. WHEN a valid request is received, THE Chat_API SHALL return a JSON response containing the assistant's reply and metadata
4. THE Chat_API SHALL include session_id in the response for conversation continuity
5. WHEN the request is missing required fields, THE Chat_API SHALL return a 422 validation error with details
6. THE Chat_API SHALL log all requests and responses for debugging

### Requirement 2: Streaming Chat Endpoint

**User Story:** As a user, I want to see responses as they are generated, so that I don't have to wait for the complete response.

#### Acceptance Criteria

1. THE Chat_API SHALL expose a `POST /api/chat/stream` endpoint for streaming responses
2. THE Chat_API SHALL use Server-Sent Events (SSE) to stream response chunks
3. WHEN streaming is initiated, THE Chat_API SHALL send chunks as they are generated by the LLM
4. THE Chat_API SHALL send a final event indicating stream completion
5. IF streaming fails mid-response, THE Chat_API SHALL send an error event with partial response
6. THE Chat_API SHALL support the same request format as the non-streaming endpoint

### Requirement 3: Health Check Endpoint

**User Story:** As a DevOps engineer, I want a health check endpoint, so that I can monitor the API's availability.

#### Acceptance Criteria

1. THE Chat_API SHALL expose a `GET /api/health` endpoint
2. THE health endpoint SHALL return status "healthy" when all dependencies are available
3. THE health endpoint SHALL check connectivity to required services (Pinecone, OpenAI)
4. WHEN a dependency is unavailable, THE health endpoint SHALL return status "unhealthy" with details
5. THE health endpoint SHALL return response time metrics

### Requirement 4: Session Management API

**User Story:** As a user, I want my conversations to be saved and retrievable, so that I can reference past discussions.

#### Acceptance Criteria

1. THE Chat_API SHALL expose a `GET /api/sessions` endpoint to list all sessions
2. THE Chat_API SHALL expose a `GET /api/sessions/{session_id}` endpoint to retrieve a specific session
3. THE Chat_API SHALL expose a `DELETE /api/sessions/{session_id}` endpoint to delete a session (optional)
4. THE Session_Store SHALL persist sessions to JSON files in a configurable directory
5. WHEN a new session is created, THE Session_Store SHALL generate a unique session_id with timestamp
6. THE Session_Store SHALL store session metadata including created_at, updated_at, and message_count

### Requirement 5: Collapsible Chat Interface

**User Story:** As a user, I want a chat interface in the right corner of the page, so that I can ask questions while browsing.

#### Acceptance Criteria

1. THE Chat_Interface SHALL be positioned in the right corner of the page
2. THE Chat_Interface SHALL be collapsible/expandable with a toggle button
3. WHEN collapsed, THE Chat_Interface SHALL show only a chat icon button
4. WHEN expanded, THE Chat_Interface SHALL display the full chat window with messages and input
5. THE Chat_Interface SHALL have a fixed width (default: 400px) and adjustable height
6. THE Chat_Interface SHALL remain visible while scrolling the main page content

### Requirement 6: Message Display

**User Story:** As a user, I want to see my conversation history clearly, so that I can follow the discussion.

#### Acceptance Criteria

1. THE Chat_Interface SHALL show messages in chronological order (oldest at top)
2. THE Chat_Interface SHALL visually distinguish user messages from assistant messages
3. THE Chat_Interface SHALL support markdown formatting in assistant responses
4. THE Chat_Interface SHALL display timestamps for each message
5. WHEN a new message arrives, THE Chat_Interface SHALL auto-scroll to the latest message
6. THE Chat_Interface SHALL show a typing indicator while waiting for streaming responses

### Requirement 7: User Input

**User Story:** As a user, I want to easily type and send messages, so that I can interact with the assistant.

#### Acceptance Criteria

1. THE Chat_Interface SHALL provide a text input field at the bottom of the chat
2. THE Chat_Interface SHALL support sending messages via Enter key or Send button
3. WHEN the input is empty, THE Chat_Interface SHALL disable the Send button
4. THE Chat_Interface SHALL clear the input field after sending a message
5. THE Chat_Interface SHALL show character count with configurable limit (default: 500)

### Requirement 8: Streaming Response Display

**User Story:** As a user, I want to see responses appear word by word, so that I get immediate feedback.

#### Acceptance Criteria

1. THE Chat_Interface SHALL display streaming response chunks as they arrive
2. THE Chat_Interface SHALL show a streaming indicator during response generation
3. WHEN streaming completes, THE Chat_Interface SHALL finalize the message display
4. IF streaming fails mid-response, THE Chat_Interface SHALL display partial response with error indicator
5. THE Chat_Interface SHALL disable input while streaming is in progress

### Requirement 9: Session History Panel

**User Story:** As a user, I want to see my past conversations, so that I can reference previous discussions.

#### Acceptance Criteria

1. THE Session_Panel SHALL be displayed in the left sidebar of the Streamlit app
2. THE Session_Panel SHALL list all past sessions with timestamps and preview text
3. WHEN a session is clicked, THE Chat_Interface SHALL load that session's conversation (read-only view)
4. THE Session_Panel SHALL show the current active session highlighted
5. THE Session_Panel SHALL provide a "New Chat" button to start a fresh session
6. WHEN "New Chat" is clicked, THE Session_Panel SHALL create a new session with a unique ID and switch to it
7. WHEN the page is refreshed, THE Session_Panel SHALL create a new session automatically
8. THE Session_Panel SHALL display sessions sorted by most recent first

### Requirement 10: Session Persistence

**User Story:** As a user, I want my conversations saved automatically, so that I don't lose my chat history.

#### Acceptance Criteria

1. THE Session_Store SHALL save each message to the session file immediately after it's added
2. THE Session_Store SHALL store sessions as JSON files in `data/sessions/` directory
3. THE Session_Store SHALL include full message history with roles, content, and timestamps
4. WHEN loading a session, THE Session_Store SHALL restore all messages in order
5. THE Session_Store SHALL handle concurrent access safely (file locking)

### Requirement 11: API Client Integration

**User Story:** As a developer, I want the frontend to communicate reliably with the backend, so that users get accurate responses.

#### Acceptance Criteria

1. THE API_Client SHALL send requests to the FastAPI backend endpoints
2. THE API_Client SHALL handle streaming responses using SSE
3. WHEN the API returns an error, THE API_Client SHALL display a user-friendly error message
4. THE API_Client SHALL implement request timeout handling (default: 60 seconds for streaming)
5. WHEN the backend is unavailable, THE API_Client SHALL show a connection error message

### Requirement 12: Error Handling and Feedback

**User Story:** As a user, I want clear feedback when something goes wrong, so that I know what to do.

#### Acceptance Criteria

1. WHEN an error occurs, THE Chat_Interface SHALL display a clear error message
2. THE Chat_Interface SHALL provide a "Retry" button for failed requests
3. THE Chat_Interface SHALL show loading states during API calls
4. WHEN the input is invalid, THE Chat_Interface SHALL show validation feedback
5. THE Chat_API SHALL return structured error responses with error codes and messages

### Requirement 13: Configuration Management

**User Story:** As a developer, I want to configure API and UI settings externally, so that I can customize behavior without code changes.

#### Acceptance Criteria

1. THE Chat_API SHALL load configuration from environment variables
2. THE Chat_API SHALL support configuration for: host, port, cors_origins, session_directory
3. THE Chat_Interface SHALL load API base URL from environment variables
4. THE Chat_Interface SHALL support configuration for: chat_width, max_input_length, streaming_enabled
5. THE system SHALL use sensible defaults when optional configuration values are not provided

### Requirement 14: CORS Support

**User Story:** As a developer, I want the API to support CORS, so that the frontend can communicate with it from different origins.

#### Acceptance Criteria

1. THE Chat_API SHALL enable CORS middleware with configurable allowed origins
2. THE Chat_API SHALL allow credentials in CORS requests
3. THE Chat_API SHALL support all standard HTTP methods (GET, POST, DELETE, OPTIONS)
4. FOR development, THE Chat_API SHALL allow all origins by default

### Requirement 15: API Authentication (Optional)

**User Story:** As a developer, I want optional API authentication, so that I can secure the endpoints when needed.

#### Acceptance Criteria

1. THE Chat_API SHALL support optional API key authentication
2. WHEN authentication is enabled, THE Chat_API SHALL validate API keys in request headers
3. WHEN authentication fails, THE Chat_API SHALL return a 401 Unauthorized response
4. THE Chat_API SHALL allow disabling authentication for development/demo use
5. THE API_Client SHALL include authentication headers when configured
